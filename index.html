<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A Produtos Farmac√™uticos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="not-logged">

<aside id="main-sidebar" class="sidebar" style="display: none;">
    <div style="padding: 20px; text-align: center;">
        <h3 style="color: white; margin: 0;">J.A Farma</h3>
    </div>
    <nav class="menu">
        <button onclick="showTab('intro')">IN√çCIO</button>
        <button onclick="showTab('aba-estoque')">ESTOQUE</button>
        <button onclick="showTab('aba-nfe')">EMISS√ÉO NF-e</button>
        <button onclick="showTab('serv2')">HIST√ìRICO</button>
        <button class="admin-only" onclick="showTab('serv1')">AN√ÅLISE MENSAL</button>
        <button class="admin-only" onclick="showTab('aba-gestao')">EQUIPE</button>
        <button onclick="logout()" style="color: #ff4d4f; margin-top: 20px;">SAIR</button>
    </nav>
</aside>

<main id="main-content" class="content">

    <section id="aba-login" class="tab active">
        <div class="login-box">
    <h2 style="color: #1e3a8a; margin-bottom: 10px;">Portal J.A</h2>
    <p style="color: #64748b; margin-bottom: 25px;">Sistema Integrado de Gest√£o</p>

    <input type="text" id="login-user" placeholder="Usu√°rio" class="modal-input">
    <input type="password" id="login-pass" placeholder="Senha" class="modal-input">

    <p id="msg-erro" style="color: #ef4444; font-weight: bold; font-size: 0.9rem; display: none; margin: 10px 0;"></p>
    <button id="btn-login" class="btn-primary" style="width: 100%; margin-top: 15px;">ACESSAR SISTEMA</button>
</div>
    </section>

   <section id="intro" class="tab">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 85vh; text-align: center;">
        
        <div class="welcome-banner">
            <div class="user-avatar" id="user-initials">--</div> <div class="welcome-texts">
                <p id="greeting-time">Ol√°</p> <h1><span id="display-username">Usu√°rio</span></h1> <p style="font-size: 0.8rem; opacity: 0.9;">
                    <span class="status-online"></span> Sistema Online
                </p>
            </div>
        </div>

        <button class="glass-card card-hover" onclick="iniciarCotacao()" style="padding: 30px 60px; border: 2px solid #1677ff; cursor: pointer; display: flex; align-items: center; gap: 20px; background: rgba(255,255,255,0.95);">
            <h2 style="color: #1677ff; margin: 0;">‚ö° NOVA COTA√á√ÉO IA</h2>
        </button>

        <div style="display: flex; gap: 20px; margin-top: 30px;">
            <div><span style="font-weight: bold;" id="stat-total">0</span><br><small>Cota√ß√µes</small></div>
            <div><span style="font-weight: bold;" id="stat-concluidas">0</span><br><small>Vendas</small></div>
            <div><span style="font-weight: bold;" id="stat-pendentes">0</span><br><small>Pendentes</small></div>
        </div>
    </div>
</section>
    <section id="aba-estoque" class="tab">
        <div class="tab-content-wrapper">
            <button class="btn-back" onclick="showTab('intro')">‚Üê VOLTAR AO MENU</button>
            <div class="header-equipe" style="display: flex; justify-content: space-between; align-items: end;">
                <div>
                    <h1>Controle de Estoque</h1>
                    <p>Gerencie produtos, pre√ßos e disponibilidade.</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="file" id="input-xml" accept=".xml" style="display: none;" onchange="processarArquivoXML(this)">
                    <button class="btn-primary" onclick="document.getElementById('input-xml').click()" style="background: #f59e0b;">üìÇ XML (NFe)</button>
                    
                    <input type="file" id="input-csv-sidicom" accept=".csv" style="display: none;" onchange="processarArquivoSidicom(this)">
                    <button class="btn-primary" onclick="document.getElementById('input-csv-sidicom').click()" style="background: #1e40af;">üè≠ CSV (SISTEMA)</button>

                    <button class="btn-primary" onclick="abrirModalProduto()">+ NOVO</button>
                </div>
            </div>

            <div class="container-tabela">
                <div class="tabela-header-actions">
                    <input type="text" id="search-produto" placeholder="Buscar produto..." class="search-input" onkeyup="filtrarEstoqueServer()">
                </div>
                <table class="team-table">
                    <thead>
                        <tr>
                            <th>PRODUTO</th>
                            <th style="text-align: center;">QTD</th>
                            <th style="text-align: right;">CUSTO</th>
                            <th style="text-align: right;">VENDA</th>
                            <th>ANVISA</th>
                            <th style="text-align: right;">A√á√ïES</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-estoque"></tbody>
                </table>
                <div id="loader-estoque" style="text-align: center; padding: 20px; display: none;">
                    <button class="btn-primary" onclick="carregarMaisProdutos()" style="background: #cbd5e1; color: #334155;">
                        ‚¨á Carregar Mais Produtos
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section id="aba-nfe" class="tab">
        <div class="tab-content-wrapper">
            <button class="btn-back" onclick="showTab('intro')">‚Üê VOLTAR AO MENU</button>
            <div id="view-nfe-lista">
                <div class="header-equipe" style="display: flex; justify-content: space-between; align-items: end;">
                    <div><h1>Carteira de Clientes</h1><p>Selecione um cliente para emitir nota</p></div>
                    <button class="btn-primary" onclick="alternarViewNfe('cadastro')">+ NOVO CLIENTE</button>
                </div>
                <div class="container-tabela">
                    <div class="tabela-header-actions">
                        <input type="text" id="search-cliente" placeholder="Buscar..." class="search-input" onkeyup="filtrarClientes()">
                    </div>
                    <table class="team-table">
                        <thead><tr><th>RAZ√ÉO SOCIAL</th><th>CNPJ</th><th>CIDADE/UF</th><th style="text-align: right;">A√á√ÉO</th></tr></thead>
                        <tbody id="tabela-clientes"></tbody>
                    </table>
                </div>
            </div>
             <div id="view-nfe-cadastro" style="display: none;">
                <div class="header-equipe"><h1>Novo Cliente</h1></div>
                <div class="glass-card">
                    <div class="form-grid-3">
                        <div class="input-group"><label>CNPJ</label><input type="text" id="cad-cnpj" class="modal-input"></div>
                        <div class="input-group"><label>Raz√£o Social</label><input type="text" id="cad-nome" class="modal-input"></div>
                        <div class="input-group"><label>IE</label><input type="text" id="cad-ie" class="modal-input"></div>
                    </div>
                    <div class="form-grid-3" style="margin-top: 20px;">
                        <div class="input-group"><label>Cidade</label><input type="text" id="cad-cidade" class="modal-input"></div>
                        <div class="input-group"><label>UF</label><input type="text" id="cad-uf" class="modal-input"></div>
                        <div class="input-group"><label>Email</label><input type="text" id="cad-email" class="modal-input"></div>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn-primary" onclick="salvarNovoCliente()">SALVAR</button>
                        <button class="btn-back" onclick="alternarViewNfe('lista')">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="serv2" class="tab">
        <div class="tab-content-wrapper">
            <button class="btn-back" onclick="showTab('intro')">‚Üê VOLTAR AO MENU</button>
            <div class="header-equipe">
                <h1>Hist√≥rico de Cota√ß√µes</h1>
                <p>Acompanhe o status de todas as licita√ß√µes e or√ßamentos</p>
            </div>
            <div class="dashboard-stats">
                <div class="stat-card"><span class="stat-label">Total</span><span class="stat-value" id="stat-total">0</span></div>
                <div class="stat-card"><span class="stat-label">Vendas</span><span class="stat-value" id="stat-concluidas" style="color: #10b981;">0</span></div>
                <div class="stat-card"><span class="stat-label">Pendentes</span><span class="stat-value" id="stat-pendentes" style="color: #f59e0b;">0</span></div>
            </div>
            <div class="container-tabela">
                <div class="tabela-header-actions">
                    <input type="text" id="search-history" placeholder="Buscar..." class="search-input">
                </div>
                <table class="team-table">
                    <thead><tr><th>Cliente</th><th>Vendedor</th><th>Data</th><th>Status</th><th style="text-align: right;">A√ß√µes</th></tr></thead>
                    <tbody id="tabela-corpo"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="aba-upload" class="tab">
        <div class="tab-content-wrapper">
            <button class="btn-back" onclick="showTab('intro')">‚Üê VOLTAR AO MENU</button>
            <div class="header-equipe"><h1>Processamento Inteligente</h1><p>Verifica√ß√£o de Estoque e Cota√ß√£o via IA</p></div>
            <div class="upload-box">
                <div class="upload-item">
                    <div><span>üìÑ Lista de Necessidades (Cliente)</span></div>
                    <input type="file" id="pdf-base" accept=".pdf">
                </div>
                <div id="status-estoque" style="display:none; margin: 20px 0;">
                    <h4 style="color: #1e3a8a; margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">
                        üîç Resultado da An√°lise
                    </h4>
                    <div style="background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 12px; text-align: left;">ITEM</th>
                                    <th style="padding: 12px; text-align: center;">QTD</th>
                                    <th style="padding: 12px; text-align: center;">STATUS</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-conferencia-body"></tbody>
                        </table>
                    </div>
                    <div id="msg-resumo-estoque"></div>
                </div>
                <div class="upload-item">
                    <div><span>üìë Or√ßamentos Fornecedores (Opcional)</span></div>
                    <input type="file" id="pdf-fornecedores" accept=".pdf" multiple>
                </div>
                <button class="btn-primary" id="btn-processar" onclick="processarAnaliseIA()" style="width: 100%; margin-top: 20px;">INICIAR AN√ÅLISE</button>
            </div>
        </div>
    </section>

    <section id="aba-gestao" class="tab">
        <div class="tab-content-wrapper">
            <button class="btn-back" onclick="showTab('intro')">‚Üê VOLTAR AO MENU</button>
            <div class="header-equipe">
                <h1>Gest√£o de Acessos</h1>
                <p>Controle de usu√°rios do sistema (Exclusivo Administrador)</p>
            </div>
            <div class="glass-card" style="margin-bottom: 30px; border-left: 5px solid #1677ff;">
                <h3 style="color: #1e3a8a; margin-bottom: 15px;">üë§ Cadastrar Novo Colaborador</h3>
                <div class="form-grid-3">
                    <div class="input-group"><label>Nome Completo</label><input type="text" id="new-nome" class="modal-input" placeholder="Ex: Jo√£o Silva"></div>
                    <div class="input-group"><label>Usu√°rio (Login)</label><input type="text" id="new-user" class="modal-input" placeholder="Ex: joao.silva"></div>
                    <div class="input-group"><label>Senha de Acesso</label><input type="text" id="new-pass" class="modal-input" placeholder="******"></div>
                </div>
                <div class="form-grid-3" style="margin-top: 15px; grid-template-columns: 1fr 2fr;">
                    <div class="input-group">
                        <label>Perfil de Acesso</label>
                        <select id="new-perfil" class="modal-input" style="height: 45px;">
                            <option value="COLABORADOR">Colaborador (Vendas/Estoque)</option>
                            <option value="ADMIN">Administrador (Total)</option>
                        </select>
                    </div>
                    <div class="input-group" style="display: flex; align-items: end;">
                        <button class="btn-primary" onclick="adicionarFuncionario()" style="width: 100%; height: 45px; margin: 0;">üíæ SALVAR USU√ÅRIO NO BANCO</button>
                    </div>
                </div>
            </div>
            <h3 style="color: #64748b; margin-bottom: 10px;">Usu√°rios Ativos no Sistema</h3>
            <div class="container-tabela">
                <table class="team-table">
                    <thead><tr><th>NOME</th><th>LOGIN</th><th>SENHA</th><th>PERFIL</th><th style="text-align: right;">A√á√ÉO</th></tr></thead>
                    <tbody id="tabela-usuarios"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="serv1" class="tab">
        <div class="tab-content-wrapper">
            <button class="btn-back" onclick="showTab('intro')">‚Üê VOLTAR AO MENU</button>
            <div class="header-equipe">
                <h1>An√°lise de Mercado & Performance</h1>
                <p>Comparativo de Vendas (Loja vs Mercado) e An√°lise de Pre√ßos.</p>
            </div>
            
            <div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                <div class="chart-container" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                    <h3 style="color: #1e3a8a; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        üî• Top 10 - Mais Vendidos (Qtd)
                        <span style="font-size: 0.8rem; color: #64748b; font-weight: normal; float: right;">Sua Loja vs M√©dia Mercado</span>
                    </h3>
                    <canvas id="chartTopItens"></canvas>
                </div>

                <div class="chart-container" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                    <h3 style="color: #ef4444; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        üìâ Top 10 - Oportunidades (Estoque Parado)
                        <span style="font-size: 0.8rem; color: #64748b; font-weight: normal; float: right;">Seu Pre√ßo vs Pre√ßo Mercado</span>
                    </h3>
                    <canvas id="chartMenosVendidos"></canvas>
                </div>

                <div class="chart-container" style="grid-column: span 2; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                    <h3 style="color: #1e3a8a;">üìä Volume de Status das Cota√ß√µes</h3>
                    <div style="height: 300px; display: flex; justify-content: center;">
                        <canvas id="chartVolumeVendas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </section>

</main>

<div id="modalXML" class="modal">
    <div class="modal-content" style="width: 800px; max-height: 90vh;">
        <h2 style="color: #1e3a8a;">Importa√ß√£o de XML (Nota Fiscal)</h2>
        <p style="color: #64748b; margin-bottom: 15px;">Confira os itens abaixo antes de lan√ßar no estoque.</p>
        <div style="overflow-y: auto; max-height: 400px; border: 1px solid #e2e8f0; border-radius: 8px;">
            <table class="team-table">
                <thead><tr><th>Produto (XML)</th><th>EAN/C√≥digo</th><th>Qtd</th><th>Custo Unit.</th><th>Total</th></tr></thead>
                <tbody id="tbody-xml"></tbody>
            </table>
        </div>
        <div style="margin-top: 20px; text-align: right; display: flex; justify-content: space-between; align-items: center;">
            <div style="text-align: left;"><span style="font-weight: bold; font-size: 1.1rem; color: #1e3a8a;" id="total-xml">Total da Nota: R$ 0,00</span></div>
            <div><button onclick="document.getElementById('modalXML').style.display='none'" class="btn-back">Cancelar</button><button class="btn-primary" onclick="confirmarImportacaoBanco()">‚úÖ CONFIRMAR E LAN√áAR</button></div>
        </div>
    </div>
</div>

<div id="dadosCotacaoModal" class="modal">
    <div class="modal-content" style="width: 450px;">
        <h2 style="color: #1e3a8a; margin-bottom: 15px;">Nova Cota√ß√£o</h2>
        <div class="input-group" style="margin-bottom: 15px;"><label>Cliente / Hospital</label><input type="text" id="cotacaoCliente" placeholder="Ex: Hospital Santa Casa" class="modal-input"></div>
        <div class="input-group" style="margin-bottom: 15px;"><label>Vendedor</label><input type="text" id="cotacaoVendedor" readonly class="modal-input" style="background: #f1f5f9;"></div>
        <div class="input-group" style="margin-bottom: 20px;"><label>Regi√£o de Envio (Frete Autom√°tico)</label>
            <select id="cotacaoRegiao" class="modal-input" style="height: 45px;"><option value="0.30">Sudeste (30%)</option><option value="0.35">Sul (35%)</option><option value="0.35">Centro-Oeste (35%)</option><option value="0.45">Nordeste (45%)</option><option value="0.60">Norte (60%)</option></select>
        </div>
        <div class="modal-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="fecharDadosCotacao()" class="btn-back" style="margin:0;">Cancelar</button><button class="btn-primary" onclick="confirmarDadosCotacao()">Confirmar</button>
        </div>
    </div>
</div>

<div id="modalFeedback" class="modal">
    <div class="modal-content">
        <h2 style="color: #1e3a8a;">Observa√ß√£o / Feedback</h2>
        <textarea id="textoFeedback" rows="4" class="modal-input"></textarea>
        <input type="hidden" id="idCotaFeedback">
        <div class="modal-actions" style="margin-top: 10px; text-align: right;">
            <button class="btn-primary" onclick="salvarFeedbackConfirmado()">Salvar</button>
            <button onclick="document.getElementById('modalFeedback').style.display='none'" class="btn-back">Cancelar</button>
        </div>
    </div>
</div>

<div id="modalProduto" class="modal">
    <div class="modal-content" style="width: 600px;">
        <h2 style="color: #1e3a8a;" id="tituloModalProd">Gerenciar Produto</h2>
        <input type="hidden" id="prod-id">
        <div class="form-grid-3">
            <div class="input-group" style="grid-column: span 2;"><label>Nome do Produto</label><input type="text" id="prod-nome" class="modal-input" placeholder="Ex: Luva Latex"></div>
            <div class="input-group"><label>C√≥digo Barras/EAN</label><input type="text" id="prod-codigo" class="modal-input"></div>
        </div>
        <div class="form-grid-3" style="margin-top: 15px;">
            <div class="input-group"><label>Estoque</label><input type="number" id="prod-qtd" class="modal-input"></div>
            <div class="input-group"><label>Custo (R$)</label><input type="number" step="0.01" id="prod-custo" class="modal-input"></div>
            <div class="input-group"><label>Venda (R$)</label><input type="number" step="0.01" id="prod-venda" class="modal-input"></div>
        </div>
        <div class="form-grid-3" style="margin-top: 15px;">
            <div class="input-group"><label>Fabricante</label><input type="text" id="prod-fabricante" class="modal-input"></div>
            <div class="input-group" style="grid-column: span 2;"><label>Registro ANVISA</label><input type="text" id="prod-anvisa" class="modal-input"></div>
        </div>
        <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="document.getElementById('modalProduto').style.display='none'" class="btn-back" style="margin:0;">Cancelar</button>
            <button class="btn-primary" onclick="salvarProduto()">SALVAR PRODUTO</button>
        </div>
    </div>
</div>

<script src="app.js"></script>
</body>
</html>